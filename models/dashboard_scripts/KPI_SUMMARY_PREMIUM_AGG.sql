{{ config(materialized='table') }}

SELECT *,
	MONTHNAME(REPORT_DATE) AS REPORT_MONTHNAME,
	MONTH(REPORT_DATE) AS REPORT_MONTHNUMBER,
	YEAR(REPORT_DATE) AS REPORT_YEAR,
	DATE_TRUNC('month',REPORT_DATE) AS REPORT_MONTHEND,
	DATE_TRUNC('week',REPORT_DATE) AS REPORT_WEEKEND
FROM(
	SELECT 
		REPORT_DATE,
		PAYMENT_SCHEDULE_NAME,
		EXPOSURE_NAME,
		ISSUED_POLICY_FLAG,
		PURCHASE_TYPE,
		COUNTRY,
		STATE,
		POLICY_USAGE,
		PERSONALIZED_PLAN_TYPE,
		HOME_TYPE,
		POLICY_COUNT_LOCATOR,
		EXPOSURE_COUNT_LOCATOR,
		QUOTE_COUNT_LOCATOR,
		CUSTOMER_BASE_COUNT_LOCATOR,
		CANCELLED_POLICY_COUNT_LOCATOR,
		AGENCY_ID,
		AGENCY_CONTACT_NAME, 
		AGENT_ID,
		AGENT_ON_RECORD,
		CANCELLATION_FLAG, 
		CANCELLATION_DURATION,
		CANCELLATION_DURATION_BUCKET, 
		CANCELLATION_REASON,
		GROSS_WRITTEN_PREMIUM_AMOUNT,
		GROSS_WRITTEN_PREMIUM_AMOUNT_CHANGE,
		EARNED_PREMIUM_AMOUNT
	FROM {{ ref('KPI_SUMMARY_ISSUED_POLICY') }}
	UNION ALL
	SELECT 
		REPORT_DATE,
		PAYMENT_SCHEDULE_NAME,
		EXPOSURE_NAME,
		ISSUED_POLICY_FLAG,
		PURCHASE_TYPE,
		COUNTRY,
		STATE,
		POLICY_USAGE,
		PERSONALIZED_PLAN_TYPE,
		HOME_TYPE,
		POLICY_COUNT_LOCATOR,
		EXPOSURE_COUNT_LOCATOR,
		QUOTE_COUNT_LOCATOR,
		CUSTOMER_BASE_COUNT_LOCATOR,
		CANCELLED_POLICY_COUNT_LOCATOR,
		AGENCY_ID,
		AGENCY_CONTACT_NAME, 
		AGENT_ID,
		AGENT_ON_RECORD, 
		CANCELLATION_FLAG, 
		CANCELLATION_DURATION,
		CANCELLATION_DURATION_BUCKET,
		CANCELLATION_REASON,
		GROSS_WRITTEN_PREMIUM_AMOUNT,
		GROSS_WRITTEN_PREMIUM_AMOUNT_CHANGE,
		EARNED_PREMIUM_AMOUNT
	FROM {{ ref('KPI_SUMMARY_QUOTE_NOT_ISSUED') }}
	UNION ALL
	SELECT 
		REPORT_DATE,
		PAYMENT_SCHEDULE_NAME,
		EXPOSURE_NAME,
		ISSUED_POLICY_FLAG,
		PURCHASE_TYPE,
		COUNTRY,
		STATE,
		POLICY_USAGE,
		PERSONALIZED_PLAN_TYPE,
		HOME_TYPE,
		POLICY_COUNT_LOCATOR,
		EXPOSURE_COUNT_LOCATOR,
		QUOTE_COUNT_LOCATOR,
		CUSTOMER_BASE_COUNT_LOCATOR,
		CANCELLED_POLICY_COUNT_LOCATOR,
		AGENCY_ID,
		AGENCY_CONTACT_NAME, 
		AGENT_ID,
		AGENT_ON_RECORD, 
		CANCELLATION_FLAG, 
		CANCELLATION_DURATION,
		CANCELLATION_DURATION_BUCKET,
		CANCELLATION_REASON,
		GROSS_WRITTEN_PREMIUM_AMOUNT,
		GROSS_WRITTEN_PREMIUM_AMOUNT_CHANGE,
		EARNED_PREMIUM_AMOUNT
	FROM {{ ref('KPI_SUMMARY_QUOTE_ISSUED') }}
	UNION ALL
	SELECT 
		REPORT_DATE,
		PAYMENT_SCHEDULE_NAME,
		EXPOSURE_NAME,
		ISSUED_POLICY_FLAG,
		PURCHASE_TYPE,
		COUNTRY,
		STATE,
		POLICY_USAGE,
		PERSONALIZED_PLAN_TYPE,
		HOME_TYPE,
		POLICY_COUNT_LOCATOR,
		EXPOSURE_COUNT_LOCATOR,
		QUOTE_COUNT_LOCATOR,
		CUSTOMER_BASE_COUNT_LOCATOR,
		CANCELLED_POLICY_COUNT_LOCATOR,
		AGENCY_ID,
		AGENCY_CONTACT_NAME, 
		AGENT_ID,
		AGENT_ON_RECORD, 
		CANCELLATION_FLAG, 
		CANCELLATION_DURATION,
		CANCELLATION_DURATION_BUCKET,
		CANCELLATION_REASON,
		GROSS_WRITTEN_PREMIUM_AMOUNT,
		GROSS_WRITTEN_PREMIUM_AMOUNT_CHANGE,
		EARNED_PREMIUM_AMOUNT
	FROM {{ ref('KPI_SUMMARY_CANCELLED_POLICY') }}
) X